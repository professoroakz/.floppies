name: Test Installation

on:
  pull_request:
    paths:
      - 'install.sh'
      - 'scripts/**'
      - 'tests/**'
  workflow_dispatch:

jobs:
  syntax-check:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check shell scripts syntax
        run: |
          echo "Checking main install script..."
          bash -n install.sh
          bash -n quick-install.sh
          bash -n verify.sh
          
          echo "Checking all module scripts..."
          for script in scripts/*.sh; do
            echo "Checking $script..."
            bash -n "$script"
          done
          
          echo "Checking test scripts..."
          for script in tests/*.sh; do
            echo "Checking $script..."
            bash -n "$script"
          done
          
          echo "âœ… All syntax checks passed!"
      
      - name: Run shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          
          echo "Running shellcheck on main scripts..."
          shellcheck -x install.sh || true
          shellcheck quick-install.sh || true
          shellcheck verify.sh || true
          
          echo "Running shellcheck on module scripts..."
          shellcheck scripts/*.sh || true
          
          echo "Running shellcheck on test scripts..."
          shellcheck tests/*.sh || true

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run unit tests
        run: |
          cd tests
          chmod +x *.sh
          ./test-install.sh
          ./test-scripts.sh

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run integration tests
        run: |
          cd tests
          chmod +x *.sh
          ./test-integration.sh

  test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run complete test suite
        run: |
          cd tests
          chmod +x *.sh
          ./run-tests.sh

  test-core-ubuntu:
    name: Test Core Install (Ubuntu)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test core installation (dry-run)
        run: |
          # Test that install script runs and shows menu
          echo "Testing install script execution..."
          timeout 5 ./install.sh || true
          
          # Test OS detection
          bash -c 'source install.sh; detect_os; echo "Detected: $OS"' || true

  test-core-macos:
    name: Test Core Install (macOS)
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test macOS detection
        run: |
          timeout 5 ./install.sh || true
          echo "macOS test completed"
